import requests
import json
import csv
import sqlite3
import time
from datetime import datetime

import os
print(os.listdir("/content/"))  # This will show all files in Colab


from google.colab import files

files.download("crypto_data.csv")  # Replace with your actual file name


def fetch_coinmarketcap_data(api_key, symbol="BTC", convert="USD"):
    url = "https://pro-api.coinmarketcap.com/v1/cryptocurrency/quotes/latest"
    headers = {
        "Accepts": "application/json",
        "X-CMC_PRO_API_KEY": api_key,
    }
    params = {
        "symbol": symbol,
        "convert": convert
    }

    response = requests.get(url, headers=headers, params=params)
    data = response.json()

    if "data" in data and symbol in data["data"]:
        market_data = data["data"][symbol]["quote"][convert]
        return {
            "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "price": market_data["price"],
            "volume_24h": market_data["volume_24h"],
            "percent_change_1h": market_data["percent_change_1h"],
            "percent_change_24h": market_data["percent_change_24h"],
            "market_cap": market_data["market_cap"]
        }
    else:
        return {"error": "Invalid response from API"}

def save_to_csv(data, filename="crypto_data.csv"):
    fieldnames = ["timestamp", "price", "volume_24h", "percent_change_1h", "percent_change_24h", "market_cap"]
    try:
        with open(filename, mode="a", newline="") as file:
            writer = csv.DictWriter(file, fieldnames=fieldnames)
            if file.tell() == 0:
                writer.writeheader()
            writer.writerow(data)
    except Exception as e:
        print("Error saving to CSV:", e)

def save_to_db(data, db_name="crypto_data.db"):
    try:
        conn = sqlite3.connect(db_name)
        cursor = conn.cursor()
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS market_data (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                timestamp TEXT,
                price REAL,
                volume_24h REAL,
                percent_change_1h REAL,
                percent_change_24h REAL,
                market_cap REAL
            )
        """)
        cursor.execute("""
            INSERT INTO market_data (timestamp, price, volume_24h, percent_change_1h, percent_change_24h, market_cap)
            VALUES (?, ?, ?, ?, ?, ?)
        """, (data["timestamp"], data["price"], data["volume_24h"], data["percent_change_1h"], data["percent_change_24h"], data["market_cap"]))
        conn.commit()
        conn.close()
    except Exception as e:
        print("Error saving to database:", e)

def run_auto_fetch(interval=1):
    API_KEY = 'd235ffdf-58ea-4866-8c97-bbc3ad649853'  # Replace with your actual API key
    while True:
        crypto_data = fetch_coinmarketcap_data(API_KEY, "BTC", "USD")
        if "error" not in crypto_data:
            save_to_csv(crypto_data)
            save_to_db(crypto_data)
            print("Data fetched and stored at:", crypto_data["timestamp"])
        else:
            print("API Error:", crypto_data["error"])
        time.sleep(interval)  # Wait for 'interval' seconds before fetching again

# Start fetching data every 1 SECOND
try:
    run_auto_fetch(1)
except KeyboardInterrupt:
    print("Data fetching stopped by user.")
